name: Deploy K3s Infrastructure

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      TF_WORKING_DIR: ./infra/terraform
      ANSIBLE_DIR: ./infra/ansible

    steps:
      # --- Étape 1 : Récupération du code ---
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Étape 2 : Installer OpenTofu ---
      - name: Install OpenTofu
        run: |
          curl -fsSL https://get.opentofu.org/install.sh | sudo bash
          tofu version

      # --- Étape 3 : Installer Ansible & AWS CLI ---
      - name: Install Ansible & AWS CLI
        run: |
          sudo apt update
          sudo apt install -y ansible unzip
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install
          aws --version
          ansible --version

      # --- Étape 4 : Configurer AWS Credentials ---
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1

      # --- Étape 5 : Exécuter OpenTofu ---
      - name: Apply OpenTofu (Terraform)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          tofu init
          tofu apply -auto-approve

      # --- Étape 6 : Exécuter Ansible ---
      - name: Configure K3s cluster via Ansible
        working-directory: ${{ env.ANSIBLE_DIR }}
        run: |
          ansible-playbook -i inventory.ini playbook.yml

      # --- Étape 7 : Vérification ---
      - name: Show generated inventory
        working-directory: ${{ env.ANSIBLE_DIR }}
        run: cat inventory.ini