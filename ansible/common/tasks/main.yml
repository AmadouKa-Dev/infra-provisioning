---
- name: Mise à jour des paquets
  apt:
    update_cache: yes
    cache_valid_time: 3600
    upgrade: safe

- name: Installer pip
  apt:
    name: python3-pip
    state: present

# Nécessaire pour que kubernetes gère la mémoire
- name: Désactiver swap
  command: swapoff -a

- name: Supprimer swap du fstab
  replace:
    path: /etc/fstab
    regexp: '^([^#].*swap.*)$'
    replace: '# \1'
    
- name: Désactiver UFW
  command: ufw disable
  become: true

- name: Activer les modules kernel nécessaires
  shell: |
    modprobe overlay
    modprobe br_netfilter

# Kubernetes contrôle le routage et les règles de firewall pour le trafic entre pods et entre nœuds
- name: Configurer les paramètres réseau Kubernetes
  copy:
    dest: /etc/sysctl.d/k8s.conf
    content: |
      net.bridge.bridge-nf-call-iptables  = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward                 = 1

- name: Recharger sysctl
  command: sysctl --system
